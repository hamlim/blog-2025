/// <reference types="bun" />
import matter from "gray-matter";
import { glob } from "tinyglobby";

type RawFrontmatter = {
  title: string;
  slug: string;
  tags: Array<string>;
  description: string;
  date: number;
};

let metadataPath = "./src/metadata.gen.ts";
export let mdxDir = "./src/mdx";

export async function generateMetadata() {
  let contents = `/* Autogenerated file */
/* do not edit */`;

  let metadata: Record<string, RawFrontmatter> = {};

  let mdxFiles = await glob(`${mdxDir}/**/*.mdx`);

  await Promise.all(
    mdxFiles.map(async (file) => {
      let content = await Bun.file(file).text();
      let { data } = matter(content);
      metadata[file.replace(mdxDir.replace("./", ""), "").replace(".mdx", "")] =
        data as RawFrontmatter;
    }),
  );

  contents += `
export let metadata = ${JSON.stringify(metadata, null, 2)};`;

  await Bun.write(metadataPath, contents);
  await Bun.$`bun run format`;
}

if (import.meta.main) {
  await generateMetadata();
}
