import watcher from "@parcel/watcher";
import matter from "gray-matter";
/// <reference types="bun" />
import { glob } from "tinyglobby";

type RawFrontmatter = {
  title: string;
  slug: string;
  tags: Array<string>;
  description: string;
  date: number;
};

let metadataPath = "./src/metadata.gen.ts";
let mdxDir = "./src/mdx";

async function generateMetadata() {
  let contents = `/* Autogenerated file */
/* do not edit */`;

  let metadata: Record<string, RawFrontmatter> = {};

  let mdxFiles = await glob(`${mdxDir}/**/*.mdx`);

  await Promise.all(
    mdxFiles.map(async (file) => {
      let content = await Bun.file(file).text();
      let { data } = matter(content);
      metadata[file.replace(mdxDir.replace("./", ""), "").replace(".mdx", "")] =
        data as RawFrontmatter;
    }),
  );

  contents += `
export const metadata = ${JSON.stringify(metadata, null, 2)};`;

  await Bun.write(metadataPath, contents);
  await Bun.$`bun run format`;
}

await generateMetadata();

let subscription = await watcher.subscribe(mdxDir, async (err, events) => {
  await generateMetadata();
});

process.on("SIGINT", async () => {
  await subscription.unsubscribe();
  console.log("Unsubscribed from watcher");
});
